{"version":3,"file":"Menu.js","sourceRoot":"","sources":["../../../src/components/Menu/Menu.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n  forwardRef,\n  FunctionComponent,\n  PropsWithoutRef,\n  useCallback,\n  useEffect,\n  useState,\n  useRef,\n  useMemo,\n  MouseEvent\n} from 'react';\n\nimport {\n  useConsolidatedRef,\n  useUID,\n  useActiveDescendant,\n  useLazyDescendant,\n  useI18n,\n  usePrevious,\n  useDirection,\n  useTestIds\n} from '../../hooks';\nimport { ForwardProps } from '../../types';\nimport { cap, withTestIds } from '../../utils';\nimport VisuallyHiddenText from '../VisuallyHiddenText';\nimport Button from '../Button/Button';\nimport Icon from '../Icon/Icon';\n\nimport FlyoutMenuList from './FlyoutMenuList';\nimport MenuContext from './Menu.context';\nimport { StyledMenu, StyledMenuListWrapper } from './Menu.styles';\nimport { getMenuTestIds } from './Menu.test-ids';\nimport {\n  MenuContextProps,\n  MenuProps,\n  MenuItemProps,\n  AcceptedMouseEventElement\n} from './Menu.types';\nimport MenuList from './MenuList';\n\nconst Menu: FunctionComponent<MenuProps & ForwardProps> = forwardRef(function Menu(\n  props: PropsWithoutRef<MenuProps>,\n  ref: MenuProps['ref']\n) {\n  const uid = useUID();\n  const {\n    testId,\n    id = uid,\n    items = [],\n    onCreateNew,\n    mode = 'action',\n    accent,\n    scrollAt = 7,\n    emptyText,\n    onItemClick,\n    onItemActive,\n    onItemExpand,\n    loadMore,\n    onItemCollapse,\n    loading = false,\n    currentItemId,\n    header,\n    footer,\n    variant = 'drill-down',\n    focusControlEl,\n    arrowNavigationUnsupported,\n    'aria-describedby': ariaDescribedBy,\n    'aria-label': label,\n    role = 'menu',\n    listId,\n    pauseDescendantEvaluation,\n    ...restProps\n  } = props;\n\n  const testIds = useTestIds(testId, getMenuTestIds);\n\n  const t = useI18n();\n\n  const { end: endDirection, start: startDirection } = useDirection();\n  const radioName = useUID();\n  const menuRef = useConsolidatedRef(ref);\n  const previousItemCount = useRef(0);\n  const [activeDescendantUpdateId, setActiveDescendantUpdateId] = useState(0);\n  const [focusDescendant, setFocusDescendant] = useState<HTMLElement | null>(null);\n  const [flyOutActiveIdStack, setFlyoutActiveIdStack] = useState<string[]>([id]);\n  const [focusReturnEl, setFocusReturnEl] = useState<HTMLElement | null>();\n  const [preventInitialScroll, setPreventInitialScroll] = useState(false);\n  const [flyoutFocusReturnStack, setFlyoutFocusReturnStack] = useState<(HTMLElement | null)[]>([]);\n\n  const menuAsFocusControl = !focusControlEl;\n\n  const activeFlyoutSelector = useMemo(\n    () => `fieldset[data-flyout-menu-id=\"${flyOutActiveIdStack[flyOutActiveIdStack.length - 1]}\"]`,\n    [flyOutActiveIdStack]\n  );\n\n  const focusControl = useMemo(() => {\n    return focusControlEl || menuRef.current;\n  }, [focusControlEl, menuRef.current]);\n\n  const pushFlyoutId = useCallback(\n    (flyoutId: string) => {\n      setFlyoutActiveIdStack([...flyOutActiveIdStack, flyoutId]);\n    },\n    [flyOutActiveIdStack]\n  );\n\n  useEffect(() => {\n    setFlyoutActiveIdStack([...flyOutActiveIdStack, id]);\n  }, [id]);\n\n  const updateParentDescendantStack = useCallback(\n    (item: HTMLElement | null) => {\n      setFlyoutFocusReturnStack([...flyoutFocusReturnStack, item]);\n    },\n    [flyoutFocusReturnStack]\n  );\n\n  const getScopedItemId = useCallback(\n    (itemId: string) => {\n      return `${id}-item-${itemId}`;\n    },\n    [id]\n  );\n\n  const getUnscopedItemId = useCallback(\n    (itemId: string) => {\n      return itemId.split(`${id}-item-`)[1];\n    },\n    [id]\n  );\n\n  const updateActiveDescendants: MenuContextProps['updateActiveDescendants'] = useCallback(\n    ({ preventScroll = false } = {}) => {\n      setPreventInitialScroll(preventScroll);\n      setActiveDescendantUpdateId(Math.random());\n    },\n    []\n  );\n\n  const uadConfig = useMemo(\n    () => ({\n      focusEl: focusControl,\n      scope: menuRef.current,\n      scopeSelector:\n        variant === 'drill-down'\n          ? ('fieldset[aria-hidden=\"false\"]' as keyof HTMLElementTagNameMap)\n          : activeFlyoutSelector,\n      selector: `[role=\"${\n        role === 'menu' ? 'menuitem' : 'option'\n      }\"], legend` as keyof HTMLElementTagNameMap,\n      focusDescendantEl: focusDescendant,\n      clearFocusDescendant: () => {\n        setFocusDescendant(null);\n      },\n      focusReturnEl,\n      clearFocusReturn: () => {\n        setFocusReturnEl(null);\n      },\n      currentDescendantId: currentItemId ? getScopedItemId(currentItemId) : undefined,\n      preventInitialScroll,\n      clearPreventScroll: () => {\n        setPreventInitialScroll(false);\n      },\n      pauseDescendantEvaluation\n    }),\n    [\n      focusControl,\n      menuRef.current,\n      activeFlyoutSelector,\n      focusReturnEl,\n      focusDescendant,\n      currentItemId,\n      preventInitialScroll,\n      pauseDescendantEvaluation\n    ]\n  );\n\n  const { activeDescendant, descendants } = useActiveDescendant(uadConfig, [\n    activeDescendantUpdateId\n  ]);\n\n  const previousActiveDescendant = usePrevious(activeDescendant);\n\n  useLazyDescendant({\n    loading,\n    descendants,\n    previousActiveDescendant,\n    activeDescendant,\n    focusReturnEl,\n    setFocusReturnEl,\n    scrollEl: uadConfig.scope?.querySelector(uadConfig.scopeSelector)?.querySelector('ul')\n  });\n\n  // ## Bind Menu-specific navigation keyDown.\n  useEffect(() => {\n    const expandOrCollapse: (action?: 'collapse' | 'expand' | null) => void = (action = null) => {\n      if (activeDescendant) {\n        // expand\n        if (activeDescendant.dataset.expand === 'true' && action !== 'collapse') {\n          activeDescendant.querySelector<HTMLSpanElement>('span[aria-hidden=\"true\"]')?.click();\n          return;\n        }\n\n        // collapse\n        if (action !== 'expand') {\n          if (\n            variant === 'flyout' &&\n            flyOutActiveIdStack.length > 1 &&\n            flyoutFocusReturnStack.length > 0\n          ) {\n            setFlyoutActiveIdStack([...flyOutActiveIdStack].slice(0, -1));\n\n            const parentDescendant = flyoutFocusReturnStack.pop();\n            if (parentDescendant !== undefined) setFocusReturnEl(parentDescendant);\n            updateActiveDescendants();\n          } else if (activeDescendant.dataset.collapse === 'true') activeDescendant.click();\n        }\n      }\n    };\n\n    const additionalKeydown = (e: KeyboardEvent) => {\n      switch (e.key) {\n        case `Arrow${cap(endDirection)}`: {\n          if (arrowNavigationUnsupported) break;\n          expandOrCollapse('expand');\n          break;\n        }\n        case `Arrow${cap(startDirection)}`: {\n          if (arrowNavigationUnsupported) break;\n          expandOrCollapse('collapse');\n          break;\n        }\n        case 'Escape': {\n          if (\n            variant === 'flyout' &&\n            flyOutActiveIdStack.length > 1 &&\n            flyoutFocusReturnStack.length > 0\n          ) {\n            e.preventDefault();\n            e.stopPropagation();\n\n            setFlyoutActiveIdStack([...flyOutActiveIdStack].slice(0, -1));\n            const parentDescendant = flyoutFocusReturnStack.pop();\n            if (parentDescendant !== undefined) setFocusReturnEl(parentDescendant);\n            updateActiveDescendants();\n          }\n          break;\n        }\n        default:\n          break;\n      }\n\n      if (arrowNavigationUnsupported && (e.key === ' ' || e.key === 'Spacebar') && e.shiftKey) {\n        e.preventDefault();\n        expandOrCollapse();\n      }\n    };\n\n    if (activeDescendant) onItemActive?.(getUnscopedItemId(activeDescendant.id));\n\n    focusControl?.addEventListener('keydown', additionalKeydown);\n\n    return () => focusControl?.removeEventListener('keydown', additionalKeydown);\n  }, [focusControl, activeDescendant, flyOutActiveIdStack]);\n\n  // ## Update useActiveDescendant on change of items, not selection of items.\n  useEffect(() => {\n    // Next tick for DOM updates.\n    const timeoutId = setTimeout(() => {\n      if (items.length === previousItemCount.current) {\n        const previousDescendantIds = descendants?.map(node => node.id);\n        const newDescendants = uadConfig.scope\n          ?.querySelector(uadConfig.scopeSelector)\n          ?.querySelectorAll(uadConfig.selector);\n\n        if (!newDescendants) {\n          updateActiveDescendants();\n          return;\n        }\n\n        const scopedDescendants = Array.from(newDescendants);\n\n        if (scopedDescendants?.length !== previousDescendantIds?.length) {\n          updateActiveDescendants();\n          return;\n        }\n\n        const itemsUnchanged = scopedDescendants.every(\n          (node, index) => node.id === previousDescendantIds[index]\n        );\n\n        if (!itemsUnchanged) {\n          updateActiveDescendants();\n        }\n\n        return;\n      }\n\n      previousItemCount.current = items.length;\n      updateActiveDescendants();\n    }, 0);\n\n    return () => clearTimeout(timeoutId);\n  }, [items]);\n\n  const contextValue = useMemo(() => {\n    return {\n      componentId: id,\n      'aria-label': label,\n      mode,\n      arrowNavigationUnsupported,\n      onItemClick: (\n        clickedId: MenuItemProps['id'],\n        event: MouseEvent<AcceptedMouseEventElement>\n      ) => {\n        if (menuAsFocusControl) {\n          menuRef.current?.focus();\n        }\n\n        onItemClick?.(clickedId, event);\n      },\n      onItemActive,\n      onItemExpand,\n      onItemCollapse,\n      accent,\n      scrollAt,\n      emptyText,\n      radioName,\n      loadMore,\n      loading,\n      variant,\n      focusControl,\n      updateActiveDescendants,\n      setFocusReturnEl,\n      setFocusDescendant,\n      getScopedItemId,\n      pushFlyoutId,\n      flyOutActiveIdStack,\n      updateParentDescendantStack\n    };\n  }, [\n    id,\n    label,\n    mode,\n    arrowNavigationUnsupported,\n    onItemClick,\n    onItemActive,\n    onItemExpand,\n    onItemCollapse,\n    accent,\n    scrollAt,\n    emptyText,\n    radioName,\n    loadMore,\n    loading,\n    variant,\n    focusControl,\n    updateActiveDescendants,\n    setFocusReturnEl,\n    setFocusDescendant,\n    getScopedItemId,\n    pushFlyoutId,\n    flyOutActiveIdStack,\n    updateParentDescendantStack\n  ]);\n\n  return (\n    <StyledMenu\n      data-testid={testIds.root}\n      id={id}\n      aria-describedby={menuAsFocusControl ? `${id}-menuDescription` : undefined}\n      {...restProps}\n      ref={menuRef}\n      tabIndex={menuAsFocusControl ? 0 : undefined}\n    >\n      {menuAsFocusControl && (\n        <span id={`${id}-menuDescription`} hidden>\n          {(`${t('menu_selection_instructions')} ` && ariaDescribedBy) || ''}\n        </span>\n      )}\n      {label && <VisuallyHiddenText id={`${id}-menuLabel`}>{label}</VisuallyHiddenText>}\n\n      {header && <header>{header}</header>}\n\n      <StyledMenuListWrapper>\n        <MenuContext.Provider value={contextValue}>\n          {variant === 'drill-down' ? (\n            <MenuList\n              items={items}\n              id={listId}\n              menuRole={role}\n              aria-labelledby={label ? `${id}-menuLabel` : undefined}\n            />\n          ) : (\n            <FlyoutMenuList items={items} menuRole={role} />\n          )}\n        </MenuContext.Provider>\n      </StyledMenuListWrapper>\n      {(onCreateNew || footer) && (\n        <footer>\n          {onCreateNew ? (\n            <Button data-testid={testIds.createNew} variant='link' onClick={onCreateNew}>\n              <Icon name='plus' /> {t('create_new')}\n            </Button>\n          ) : (\n            footer\n          )}\n        </footer>\n      )}\n    </StyledMenu>\n  );\n});\n\nexport default withTestIds(Menu, getMenuTestIds);\n"]}