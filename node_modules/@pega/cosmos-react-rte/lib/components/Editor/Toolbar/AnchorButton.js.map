{"version":3,"file":"AnchorButton.js","sourceRoot":"","sources":["../../../../src/components/Editor/Toolbar/AnchorButton.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n  FC,\n  useRef,\n  useState,\n  ChangeEvent,\n  useEffect,\n  MouseEvent,\n  KeyboardEvent as ReactKeyboardEvent,\n  useLayoutEffect\n} from 'react';\nimport { Editor, EditorSelection } from 'tinymce';\n\nimport {\n  Button,\n  CardContent,\n  Grid,\n  Icon,\n  registerIcon,\n  Input,\n  Popover,\n  useOuterEvent,\n  ForwardProps,\n  Form,\n  useI18n\n} from '@pega/cosmos-react-core';\nimport * as chainIcon from '@pega/cosmos-react-core/lib/components/Icon/icons/chain.icon';\n\nimport ToolbarButton from '../../RichTextEditor/Toolbar/ToolbarButton';\nimport { getKeyCommand } from '../../RichTextEditor/Toolbar/utils';\n\nregisterIcon(chainIcon);\n\ninterface AnchorButtonProps {\n  osx: boolean;\n  editor: Editor;\n}\n\nconst AnchorButton: FC<AnchorButtonProps & ForwardProps> = ({ osx, editor, ...restProps }) => {\n  const t = useI18n();\n  const buttonRef = useRef<HTMLButtonElement>(null);\n  const textInputRef = useRef<HTMLInputElement>(null);\n  const urlInputRef = useRef<HTMLInputElement>(null);\n  const popoverRef = useRef(null);\n  const [selectedText, setSelectedText] = useState('');\n  const [selection, setSelection] = useState<EditorSelection | undefined>();\n  const [url, setUrl] = useState('');\n  const [urlMatch, setUrlMatch] = useState(false);\n  const [anchorMenu, setAnchorMenu] = useState(false);\n  const [shouldFocusInput, setShouldFocusInput] = useState(false);\n  const tooltip = getKeyCommand(osx, ({ ctrl }) => `${t('rte_link')} (${ctrl}K)`);\n\n  const openMenu = (opts: { focusInput?: boolean } = {}) => {\n    setAnchorMenu(true);\n    if (opts.focusInput) {\n      setShouldFocusInput(true);\n    }\n  };\n\n  const resetMenu = () => {\n    setSelection(undefined);\n    setSelectedText('');\n    setUrl('');\n    setUrlMatch(true);\n    setAnchorMenu(false);\n  };\n\n  useOuterEvent('mousedown', [popoverRef, buttonRef], () => {\n    if (anchorMenu) {\n      resetMenu();\n    }\n  });\n\n  const createLink = () => {\n    if (url && selection) {\n      editor.focus();\n      editor.selection = selection;\n      if (selection.getNode().tagName === 'A') {\n        const anchorEl = editor.selection.getNode();\n        anchorEl.setAttribute('href', url);\n        anchorEl.setAttribute('data-mce-href', url);\n        anchorEl.textContent = selectedText;\n      } else {\n        editor.insertContent(\n          `<a href='${\n            new URL(/^[a-z][a-z0-9.+-]*:/i.test(url) ? url : `https:${url}`).href\n          }'>${selectedText}</a>`\n        );\n      }\n      resetMenu();\n    }\n  };\n\n  useEffect(() => {\n    if (anchorMenu) {\n      if (editor.selection) {\n        const selectedEl = editor.selection.getNode();\n        if (selectedEl?.tagName === 'A') {\n          setSelectedText(selectedEl.textContent || '');\n          setUrl(selectedEl.getAttribute('href') || '');\n        } else {\n          setSelectedText(editor.selection.getContent({ format: 'text' }));\n        }\n        setSelection({ ...editor.selection });\n      }\n    } else {\n      resetMenu();\n    }\n  }, [anchorMenu]);\n\n  const preventDef = (e: MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n  };\n\n  const isLinkActive = () => {\n    return editor.selection.getNode().tagName === 'A' && editor.hasFocus();\n  };\n\n  const cancelAnchorCreation = (event?: KeyboardEvent | MouseEvent) => {\n    if (\n      ((event?.type === 'keydown' && (event as KeyboardEvent)?.key === 'Enter') ||\n        event?.type === 'mousedown' ||\n        !event) &&\n      anchorMenu\n    ) {\n      event?.preventDefault();\n      resetMenu();\n      buttonRef.current?.focus();\n    }\n  };\n\n  useEffect(() => {\n    const keyCommandListener = (e: KeyboardEvent) => {\n      if (e.key === 'k' && (e.metaKey || e.ctrlKey) && editor.hasFocus()) {\n        e.preventDefault();\n        openMenu({ focusInput: true });\n      }\n      if (e.key === 'Escape') {\n        cancelAnchorCreation();\n      }\n    };\n\n    editor.getDoc().addEventListener('keydown', keyCommandListener);\n\n    return () => {\n      editor.getDoc().removeEventListener('keydown', keyCommandListener);\n    };\n  }, []);\n\n  useLayoutEffect(() => {\n    if (anchorMenu && shouldFocusInput) {\n      textInputRef.current?.focus();\n      setShouldFocusInput(false);\n    }\n  }, [textInputRef.current]);\n\n  useEffect(() => {\n    // These events must be added here so they run before the native event in useArrows (used in the toolbar).\n    const onKeyDown = (e: KeyboardEvent) => {\n      e.stopPropagation();\n    };\n    textInputRef.current?.addEventListener('keydown', onKeyDown);\n    urlInputRef.current?.addEventListener('keydown', onKeyDown);\n    return () => {\n      textInputRef.current?.removeEventListener('keydown', onKeyDown);\n      urlInputRef.current?.removeEventListener('keydown', onKeyDown);\n    };\n  }, [textInputRef.current, urlInputRef.current]);\n\n  return (\n    <>\n      <ToolbarButton\n        ref={buttonRef}\n        onMouseDown={e => {\n          e.preventDefault();\n          openMenu();\n        }}\n        onKeyDown={(e: ReactKeyboardEvent) => {\n          if (e.key === 'Enter') {\n            e.preventDefault();\n            openMenu({ focusInput: true });\n          }\n        }}\n        active={isLinkActive()}\n        tooltip={tooltip}\n        label={t('rte_link')}\n        {...restProps}\n      >\n        <Icon name='chain' />\n      </ToolbarButton>\n      <Popover show={anchorMenu} target={buttonRef.current} ref={popoverRef} placement='bottom'>\n        <CardContent>\n          <Form\n            as='div'\n            actions={\n              <>\n                <Button\n                  variant='secondary'\n                  onKeyDown={cancelAnchorCreation}\n                  onMouseDown={cancelAnchorCreation}\n                  type='button'\n                >\n                  Cancel\n                </Button>\n                <Button\n                  disabled={!url || !urlMatch}\n                  name='apply'\n                  variant='primary'\n                  onClick={(e: MouseEvent) => {\n                    e.preventDefault();\n                    createLink();\n                  }}\n                >\n                  Apply\n                </Button>\n              </>\n            }\n          >\n            <Grid container={{ rowGap: 2 }}>\n              <Input\n                label='Text'\n                value={selectedText}\n                onClick={preventDef}\n                onChange={(e: ChangeEvent<HTMLInputElement>) => {\n                  setSelectedText(e.target.value);\n                }}\n                ref={textInputRef}\n              />\n              <Input\n                label='URL'\n                value={url}\n                onClick={preventDef}\n                onChange={(e: ChangeEvent<HTMLInputElement>) => {\n                  const urlInput = e.target.value;\n                  setUrl(urlInput);\n\n                  if (!urlMatch) {\n                    try {\n                      // eslint-disable-next-line no-new\n                      new URL(\n                        /^[a-z][a-z0-9+.-]*:/i.test(urlInput) ? urlInput : `https:${urlInput}`\n                      );\n                      setUrlMatch(true);\n                    } catch {\n                      setUrlMatch(false);\n                    }\n                  }\n                }}\n                onBlur={() => {\n                  try {\n                    // eslint-disable-next-line no-new\n                    new URL(/^[a-z][a-z0-9+.-]*:/i.test(url) ? url : `https:${url}`);\n                    setUrlMatch(true);\n                  } catch {\n                    setUrlMatch(false);\n                  }\n                }}\n                info={!urlMatch ? t('rte_invalid_url') : ''}\n                status={!urlMatch ? 'error' : undefined}\n                ref={urlInputRef}\n              />\n            </Grid>\n          </Form>\n        </CardContent>\n      </Popover>\n    </>\n  );\n};\n\nexport default AnchorButton;\n"]}